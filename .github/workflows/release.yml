name: Create Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type to create'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: 'Mark as prerelease? (Creates an incremental prerelease version for next patch/minor/major version)'
        required: false
        type: boolean
        default: false
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: ''

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.5'
          channel: 'stable'

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Get current version and calculate new version
        id: version_calc
        run: |
          # Fetch all tags
          git fetch --tags
          
          # Find the latest official release tag (vX.Y.Z)
          LATEST_OFFICIAL_TAG=$(git tag --list 'v*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          LATEST_OFFICIAL_VERSION=${LATEST_OFFICIAL_TAG#v}
          
          # Find the latest prerelease tag for the next version (vX.Y.Z-prerelease.N)
          LATEST_PRERELEASE_TAG=$(git tag --list 'v*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-prerelease\.[0-9]+$' | head -n1)
          LATEST_PRERELEASE_VERSION=${LATEST_PRERELEASE_TAG#v}
          
          # Parse dropdown and prerelease input
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          PRERELEASE="${{ github.event.inputs.prerelease }}"
          
          # Helper to bump version
          bump_version() {
            local version=$1
            local type=$2
            IFS='.' read -r MAJOR MINOR PATCH <<< "$version"
            case $type in
              major)
                MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor)
                MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch)
                PATCH=$((PATCH + 1)) ;;
            esac
            echo "$MAJOR.$MINOR.$PATCH"
          }
          
          if [ "$PRERELEASE" = "true" ]; then
            # Prerelease logic
            BASE_VERSION=$(bump_version "$LATEST_OFFICIAL_VERSION" "$RELEASE_TYPE")
            # Find the highest prerelease number for this base version
            EXISTING_PRERELEASE=$(git tag --list "v${BASE_VERSION}-prerelease.*" | grep -E "^v${BASE_VERSION}-prerelease\.[0-9]+" | sort -V | tail -n1)
            if [ -n "$EXISTING_PRERELEASE" ]; then
              PRERELEASE_NUM=$(echo "$EXISTING_PRERELEASE" | sed -E 's/.*-prerelease\.([0-9]+)$/\1/')
              PRERELEASE_NUM=$((PRERELEASE_NUM + 1))
            else
              PRERELEASE_NUM=1
            fi
            NEW_VERSION_NAME="$BASE_VERSION-prerelease.$PRERELEASE_NUM"
          else
            # Official release logic
            # If the latest tag is a prerelease for this version, strip the suffix
            if [[ "$LATEST_PRERELEASE_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-prerelease\.[0-9]+$ ]]; then
              BASE_VERSION="${BASH_REMATCH[1]}"
              NEW_VERSION_NAME="$BASE_VERSION"
            else
              # Otherwise, bump from latest official
              NEW_VERSION_NAME=$(bump_version "$LATEST_OFFICIAL_VERSION" "$RELEASE_TYPE")
            fi
          fi
          
          echo "VERSION_NAME=${NEW_VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION=${LATEST_OFFICIAL_VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_TYPE=${RELEASE_TYPE}" >> $GITHUB_OUTPUT

      - name: Determine Final Version String
        id: final_version
        run: |
          VERSION_NAME="${{ steps.version_calc.outputs.VERSION_NAME }}"
          BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///g')

          if [ "$BRANCH_NAME" != "main" ]; then
            VERSION_NAME="${VERSION_NAME}-${BRANCH_NAME}"
          fi

          BUILD_NUMBER=""
          if git tag --list "v${VERSION_NAME}" | grep -q "v${VERSION_NAME}"; then
            LATEST_BUILD_TAG=$(git tag --list "v${VERSION_NAME}+*" --sort=-v:refname | head -n1)
            INCREMENTAL_BUILD_NUM=1
            if [ -n "$LATEST_BUILD_TAG" ]; then
              EXISTING_BUILD_NUM=$(echo "$LATEST_BUILD_TAG" | sed -E 's/.*\+([0-9]+)$/\1/')
              INCREMENTAL_BUILD_NUM=$((EXISTING_BUILD_NUM + 1))
            fi
            BUILD_NUMBER="$INCREMENTAL_BUILD_NUM"
          fi

          FINAL_VERSION_STRING="$VERSION_NAME"
          if [ -n "$BUILD_NUMBER" ]; then
            FINAL_VERSION_STRING="${FINAL_VERSION_STRING}+${BUILD_NUMBER}"
          fi

          echo "final_version_string=$FINAL_VERSION_STRING" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Update version in pubspec.yaml
        run: |
          FINAL_VERSION_STRING="${{ steps.final_version.outputs.final_version_string }}"
          yq -i ".version = \"$FINAL_VERSION_STRING\"" pubspec.yaml
          echo "Updated pubspec.yaml to version $FINAL_VERSION_STRING"

      - name: Build All Platforms
        run: |
          flutter build apk --release --build-name=${{ steps.final_version.outputs.final_version_string }} --build-number=${{ steps.final_version.outputs.build_number }}
          flutter build appbundle --release --build-name=${{ steps.final_version.outputs.final_version_string }} --build-number=${{ steps.final_version.outputs.build_number }}
          flutter build web --release --build-name=${{ steps.final_version.outputs.final_version_string }} --build-number=${{ steps.final_version.outputs.build_number }}

      - name: Create Release Assets
        run: |
          mkdir -p release_assets
          cp build/app/outputs/flutter-apk/app-release.apk release_assets/
          cp build/app/outputs/bundle/release/app-release.aab release_assets/
          cp -r build/web release_assets/web_build
          
          cd release_assets
          zip -r web_build.zip web_build/
          cd ..

      - name: Create Git Tag and Push Changes
        run: |
          TAG_NAME="v${{ steps.final_version.outputs.final_version_string }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pubspec.yaml
          COMMIT_MSG="Release version $TAG_NAME"
          git commit -m "$COMMIT_MSG"
          git tag -a "$TAG_NAME" -m "$COMMIT_MSG"
          git push origin ${{ github.ref_name }}
          git push origin "$TAG_NAME"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.final_version.outputs.final_version_string }}
          release_name: Release v${{ steps.final_version.outputs.final_version_string }}
          body: |
            ## Release v${{ steps.final_version.outputs.final_version_string }}
            
            **Release Type:** ${{ steps.version_calc.outputs.RELEASE_TYPE }}
            **Version Name:** ${{ steps.version_calc.outputs.VERSION_NAME }}
            **Build Number:** ${{ steps.final_version.outputs.build_number }}
            **Previous Version:** ${{ steps.version_calc.outputs.CURRENT_VERSION }}
            
            **Changes:**
            ${{ github.event.inputs.release_notes }}
            
            ### Assets
            - Android APK
            - Android App Bundle
            - Web Build
            
            ### Build Information
            - Flutter Version: 3.32.5
            - Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release_assets/app-release.apk
          asset_name: app-release.apk
          asset_content_type: application/vnd.android.package-archive

      - name: Upload App Bundle
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release_assets/app-release.aab
          asset_name: app-release.aab
          asset_content_type: application/octet-stream

      - name: Upload Web Build
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release_assets/web_build.zip
          asset_name: web_build.zip
          asset_content_type: application/zip

      - name: Success Message
        run: |
          FINAL_VERSION_STRING="${{ steps.final_version.outputs.final_version_string }}"
          if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
            echo "üéâ Successfully created prerelease v${FINAL_VERSION_STRING}!"
            echo "üì± Android APK and App Bundle created"
            echo "üåê Web build created"
            echo "üè∑Ô∏è  Git tag v${FINAL_VERSION_STRING} created"
            echo "üì¶ Prerelease GitHub release created"
          else
            echo "üéâ Successfully released version v${FINAL_VERSION_STRING}!"
            echo "üì± Android APK and App Bundle created"
            echo "üåê Web build created"
            echo "üè∑Ô∏è  Git tag v${FINAL_VERSION_STRING} created"
            echo "üì¶ Official GitHub release created"
          fi
